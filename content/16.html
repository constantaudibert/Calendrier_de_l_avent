<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16 D√©cembre - Piano de No√´l</title>
    <style>
        .piano-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            color: #333;
        }

        .piano-header {
            text-align: center;
            margin-bottom: 0px;
            z-index: 10;
        }

        .piano-header h1 {
            font-family: 'Satisfy', cursive;
            color: #d4af37;
            font-size: 2em;
            margin: 10px 0;
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
        }

        /* Game Area */
        #game-board {
            position: relative;
            width: 100%;
            max-width: 320px;
            /* Largeur fixe pour 4 colonnes nettes */
            height: 400px;
            background-color: #ffffff;
            /* Fond blanc */
            border: 4px solid #d4af37;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            /* Grid lines drawn via CSS borders on columns instead of background gradient for precision */
            display: flex;
            /* Flex based columns */
        }

        /* Columns Backgrounds */
        .piano-col {
            flex: 1;
            /* 4 columns equal width */
            border-right: 1px solid #eee;
            position: relative;
            /* For containment */
        }

        .piano-col:last-child {
            border-right: none;
        }

        /* The active light trace effect */
        .col-trace {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(212, 175, 55, 0.4) 0%, transparent 100%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        .col-trace.active {
            opacity: 1;
            transition: opacity 0s;
        }

        /* The Tile */
        .tile {
            position: absolute;
            width: 25%;
            /* Exactly 1/4 */
            height: 120px;
            background: linear-gradient(135deg, #d4af37 0%, #f1c40f 100%);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.4), 0 3px 5px rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.3);

            /* Center text/icon if needed */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Note visual */
        .tile::after {
            content: 'üéµ';
            font-size: 20px;
            opacity: 0.5;
            filter: grayscale(1);
        }

        .tile.clicked {
            background: transparent;
            box-shadow: none;
            border: none;
        }

        .tile.clicked::after {
            content: '‚ú®';
            font-size: 40px;
            opacity: 1;
            filter: none;
            animation: popIcon 0.3s ease-out forwards;
        }

        @keyframes popIcon {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .tile.wrong {
            background: #e74c3c !important;
            animation: shake 0.3s;
        }

        .tile-start {
            position: absolute;
            width: 100%;
            height: 100px;
            background-color: #2ecc71;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            bottom: 0;
            left: 0;
            cursor: pointer;
            z-index: 20;
        }

        /* Overlay Messages */
        #message-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #d4af37;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 50;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 80%;
        }

        #message-overlay h2 {
            font-family: 'Satisfy', cursive;
            color: #d4af37;
            margin-top: 0;
        }

        button.retry-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #d4af37;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.1em;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="piano-wrapper">
        <div class="piano-header">
            <h1>En sc√®ne</h1>
            <p style="margin:0; font-size:0.9em; color:#777;">Joue moi ta musique pr√©f√©r√©e</p>
        </div>

        <div id="game-board">
            <!-- 4 Explicit Columns for Visual Effect -->
            <div class="piano-col" id="col-0">
                <div class="col-trace"></div>
            </div>
            <div class="piano-col" id="col-1">
                <div class="col-trace"></div>
            </div>
            <div class="piano-col" id="col-2">
                <div class="col-trace"></div>
            </div>
            <div class="piano-col" id="col-3">
                <div class="col-trace"></div>
            </div>

            <!-- Starting Block -->
            <div id="start-block" class="tile-start">COMMENCER</div>
        </div>
    </div>

    <div id="message-overlay">
        <h2 id="msg-title">Bravo !</h2>
        <p id="msg-text">Tu as jou√© la m√©lodie !</p>
        <button class="retry-btn" onclick="resetGame()">Rejouer</button>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        const NOTE_FREQS = {
            'E5': 659.25, 'D#5': 622.25, 'D5': 587.33, 'C5': 523.25,
            'B4': 493.88, 'A4': 440.00, 'G#4': 415.30, 'E4': 329.63,
            'C4': 261.63
        };

        const MELODY = [
            { n: 'E5', d: 1 }, { n: 'D#5', d: 1 }, { n: 'E5', d: 1 }, { n: 'D#5', d: 1 }, { n: 'E5', d: 1 }, { n: 'B4', d: 1 }, { n: 'D5', d: 1 }, { n: 'C5', d: 1 }, { n: 'A4', d: 2 }, // 9
            { n: 'C4', d: 1 }, { n: 'E4', d: 1 }, { n: 'A4', d: 1 }, { n: 'B4', d: 2 }, // 13
            { n: 'E4', d: 1 }, { n: 'G#4', d: 1 }, { n: 'B4', d: 1 }, { n: 'C5', d: 2 }, // 17
            { n: 'E4', d: 1 }, { n: 'E5', d: 1 }, { n: 'D#5', d: 1 }, { n: 'E5', d: 1 }, { n: 'D#5', d: 1 }, { n: 'E5', d: 1 }, { n: 'B4', d: 1 }, { n: 'D5', d: 1 }, { n: 'C5', d: 1 }, { n: 'A4', d: 2 }, // 27
            { n: 'C4', d: 1 }, { n: 'E4', d: 1 }, { n: 'A4', d: 1 }, { n: 'B4', d: 2 }, // 31
            { n: 'E4', d: 1 }, { n: 'C5', d: 1 }, { n: 'B4', d: 1 }, { n: 'A4', d: 3 }  // 35
        ];

        function playTone(note) {
            if (!note) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.type = 'sine';
            osc.frequency.setValueAtTime(NOTE_FREQS[note], audioCtx.currentTime);

            gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        // --- GAME LOGIC ---
        const board = document.getElementById('game-board');
        const startBlock = document.getElementById('start-block');
        const overlay = document.getElementById('message-overlay');
        const msgTitle = document.getElementById('msg-title');
        const msgText = document.getElementById('msg-text');

        let tiles = [];
        let gameRunning = false;
        let speed = 2.5;
        let score = 0;
        let animationFrame;
        let melodyIndex = 0;

        let lastSpawnedNote = null;
        let lastSpawnedLane = -1;

        const BASE_SPACING = 90;

        startBlock.addEventListener('mousedown', startGame);
        startBlock.addEventListener('touchstart', (e) => { e.preventDefault(); startGame(); });

        function startGame() {
            if (audioCtx.state === 'suspended') { audioCtx.resume(); }
            startBlock.style.display = 'none';
            overlay.style.display = 'none';

            document.querySelectorAll('.tile').forEach(t => t.remove());
            tiles = [];

            score = 0;
            melodyIndex = 0;
            gameRunning = true;
            lastSpawnedNote = null;
            lastSpawnedLane = -1;

            spawnTile();
            loop();
        }

        function triggerColumnEffect(laneIndex) {
            const col = document.getElementById('col-' + laneIndex);
            if (col) {
                const trace = col.querySelector('.col-trace');
                trace.classList.add('active');
                setTimeout(() => trace.classList.remove('active'), 150);
            }
        }

        function spawnTile() {
            if (melodyIndex >= MELODY.length) return;

            const tile = document.createElement('div');
            tile.classList.add('tile');

            const currentObj = MELODY[melodyIndex];
            const currentNote = currentObj.n;

            let possibleLanes = [0, 1, 2, 3];
            if (currentNote !== lastSpawnedNote && lastSpawnedLane !== -1) {
                possibleLanes = possibleLanes.filter(l => l !== lastSpawnedLane);
            }
            const lane = possibleLanes[Math.floor(Math.random() * possibleLanes.length)];

            lastSpawnedNote = currentNote;
            lastSpawnedLane = lane;

            tile.style.left = (lane * 25) + '%';
            tile.style.top = '-150px';

            tile.dataset.note = currentNote;
            tile.dataset.duration = currentObj.d;
            tile.dataset.lane = lane; // Store lane for effect

            melodyIndex++;

            const handleTap = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!gameRunning) return;

                playTone(currentNote);
                triggerColumnEffect(lane); // Light up the column

                tile.classList.add('clicked');
                tile.dataset.processed = "true";
                score++;
            };

            tile.addEventListener('mousedown', handleTap);
            tile.addEventListener('touchstart', handleTap);

            board.appendChild(tile);

            tiles.push({ el: tile, y: -150, duration: currentObj.d });
        }

        function loop() {
            if (!gameRunning) return;

            // SPAWNING
            if (tiles.length > 0) {
                const lastTile = tiles[tiles.length - 1];
                const gapPixels = lastTile.duration * BASE_SPACING;
                if ((lastTile.y + 150) > gapPixels && melodyIndex < MELODY.length) {
                    spawnTile();
                }
            }

            // MOVEMENT
            for (let i = 0; i < tiles.length; i++) {
                let t = tiles[i];
                t.y += speed;
                t.el.style.top = t.y + 'px';

                // Check missed
                if (t.y > board.clientHeight) {
                    if (!t.el.dataset.processed) {
                        gameOver(false);
                        return;
                    }
                    t.el.remove();
                    tiles.splice(i, 1);
                    i--;
                }
            }

            // WIN
            if (melodyIndex >= MELODY.length && tiles.length === 0) {
                gameOver(true);
                return;
            }

            animationFrame = requestAnimationFrame(loop);
        }

        function gameOver(win) {
            gameRunning = false;
            cancelAnimationFrame(animationFrame);

            overlay.style.display = 'block';
            if (win) {
                msgTitle.textContent = "C'est un OUI";
                msgText.textContent = "J'ai affaire √† la prochaine gagnante de la France √† un Incroyable Talent !";
                setTimeout(() => playTone('C4'), 0);
            } else {
                msgTitle.textContent = "C'est un NON";
                msgText.textContent = "Tu as perdu le rythme !";
                playTone('C3');
            }
        }

        window.resetGame = function () {
            startBlock.style.display = 'flex';
            overlay.style.display = 'none';
            document.querySelectorAll('.tile').forEach(t => t.remove());
            tiles = [];
            score = 0;
            melodyIndex = 0;
            lastSpawnedNote = null;
            lastSpawnedLane = -1;
        }

    </script>
</body>

</html>