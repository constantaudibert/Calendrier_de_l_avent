<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renforts</title>
    <style>
        #content-24 {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            position: relative;
            background: #fff;
            color: #333;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }

        /* PHASE 1: CROSSWORD */
        .cw-phase {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .cw-title {
            font-family: 'Satisfy', cursive;
            color: #d35400;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        /* The Grid */
        #cw-grid {
            display: grid;
            grid-template-columns: repeat(22, 16px);
            grid-template-rows: repeat(22, 16px);
            gap: 2px;
            margin: 20px 0;
            background: #eee;
            padding: 5px;
            border: 2px solid #333;
            border-radius: 5px;
        }

        .cell {
            width: 20px;
            height: 20px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            border: 1px solid #999;
            background: #fff;
            text-align: center;
            font-family: monospace;
            padding: 0;
            font-size: 12px;
        }

        .cell-input:focus {
            background: #e1f5fe;
            outline: 2px solid #3498db;
            z-index: 10;
        }

        .cell-input.correct {
            background: #2ecc71;
            color: white;
            border-color: #27ae60;
        }

        .cell-input.prefilled {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        /* PHASE 2: VIGNETTE */
        .vignette-phase {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .vignette-img {
            max-width: 90%;
            max-height: 50vh;
            border: 5px solid #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* PHASE 3: GAME */
        .game-phase {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            justify-content: center;
        }

        .sword-container {
            position: relative;
            width: 250px;
            height: 250px;
            background: url('images/sword_in_stone_game_asset.png') no-repeat center bottom;
            background-size: contain;
            transition: transform 0.1s;
        }

        .shake {
            animation: shake 0.5s;
            animation-iteration-count: infinite;
        }

        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        .bar-container {
            width: 80%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
            border: 2px solid #333;
        }

        .bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f1c40f, #e67e22);
            transition: width 0.1s linear;
        }

        .action-btn {
            background: #e74c3c;
            color: white;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            border: none;
            font-family: 'Satisfy', cursive;
            margin-top: 15px;
            cursor: pointer;
            box-shadow: 0 5px 0 #c0392b;
        }

        .action-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        .scientist-msg {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #bdc3c7;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 95%;
            font-size: 0.85em;
        }

        .scientist-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: url('images/scientifique_sticker.png') no-repeat center center;
            background-size: cover;
            flex-shrink: 0;
        }

        .highlight-reveal {
            background-color: #f1c40f !important;
            color: #fff !important;
            animation: pulse 1s infinite alternate;
            border-color: #d35400 !important;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(241, 196, 15, 0);
            }

            to {
                transform: scale(1.1);
                box-shadow: 0 0 10px rgba(241, 196, 15, 0.7);
            }
        }

        .tile-slot {
            width: 30px;
            height: 30px;
            border: 2px dashed #bdc3c7;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
        }

        .scrabble-tile {
            width: 30px;
            height: 30px;
            background: #e67e22;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 0 #d35400;
            user-select: none;
        }

        .scrabble-tile:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        .scrabble-tile.placed {
            background: #2ecc71;
            box-shadow: 0 3px 0 #27ae60;
        }
    </style>
</head>

<body>

    <div id="content-24">

        <!-- PHASE 1: CROSSWORD -->
        <div id="phase-cw" class="cw-phase">
            <h2 class="cw-title">Les Renforts</h2>
            <div class="scientist-msg">
                <div class="scientist-avatar"></div>
                <p style="margin:0;">"Remplis la grille pour appeler l'équipe !"</p>
            </div>

            <div id="cw-grid"></div>
            <button class="action-btn" onclick="checkCrossword()">Vérifier</button>
        </div>

        <!-- PHASE 1.5: SCRABBLE -->
        <div id="phase-scrabble" class="cw-phase" style="display:none;">
            <h2 class="cw-title">Décodage...</h2>
            <div class="scientist-msg">
                <div class="scientist-avatar"></div>
                <p style="margin:0;">"Les lettres brillent ! Recompose le nom du héros manquant !"</p>
            </div>
            <div id="scrabble-container"
                style="margin: 20px; display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; min-height: 50px;">
                <!-- Target slots -->
            </div>
            <div id="scrabble-letters"
                style="margin: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <!-- Shuffled letters -->
            </div>
            <div id="scrabble-message" style="color: #27ae60; font-weight: bold; height: 20px;"></div>
        </div>

        <!-- PHASE 2: VIGNETTE -->
        <div id="phase-vignette" class="vignette-phase">
            <h2 class="cw-title">Le Chaînon Manquant</h2>
            <div class="scientist-msg">
                <div class="scientist-avatar"></div>
                <p style="margin:0;">"MINI CONSTANT ! C'est lui ! Mais il est coincé dans le passé à Disneyland !"
                </p>
            </div>
            <img src="images/mini_constant_comic.png" class="vignette-img" alt="Mini Constant"
                onerror="this.src='images/logo_logique.png'">
            <p style="font-style:italic; font-size:0.9em;">(L'image s'estompe... Voyage Temporel !)</p>
        </div>

        <!-- PHASE 3: GAME -->
        <div id="phase-game" class="game-phase">
            <h2 class="cw-title">Décroche l'Épée !</h2>
            <div class="sword-container" id="sword-obj"></div>
            <div class="bar-container">
                <div class="bar-fill" id="power-bar"></div>
            </div>
            <button class="action-btn" onmousedown="tapSword()" ontouchstart="tapSword()">TAPER VITE !</button>
        </div>

    </div>

    <script>
        (function () {
            // --- CROSSWORD CONFIG ---
            const rows = 22;
            const cols = 22;
            const gridEl = document.getElementById('cw-grid');
            const cells = [];

            // Layout V5 (Final Fix - No Collisions):
            // 1. MMEDUCOUP (H) Row 2, Col 4 -> Ends P (2,12)
            // 2. PARISIENNE (V) Row 2, Col 12 -> Starts P (2,12). I (5,12) matches SCIENTIFIQUE
            // 3. SCIENTIFIQUE (H) Row 5, Col 10 -> Starts S (5,10). I (5,12).
            // 4. SUPERDARON (V) Row 5, Col 10 -> Starts S (5,10). End N (14,10).
            // 5. CHIRURGIEN (H) Row 14, Col 1 -> Ends N (14,10).
            // No overlap between PARISIENNE (Col 12) and CHIRURGIEN (Row 14, ends Col 10).

            const words = [
                { w: "MMEDUCOUP", r: 2, c: 4, d: "H" },
                { w: "PARISIENNE", r: 2, c: 12, d: "V" },
                { w: "SCIENTIFIQUE", r: 5, c: 10, d: "H" },
                { w: "SUPERDARON", r: 5, c: 10, d: "V" },
                { w: "CHIRURGIEN", r: 14, c: 1, d: "H" }
            ];

            // Prefilled intersection points
            const prefilled = [
                { r: 2, c: 12, val: 'P' },
                { r: 5, c: 12, val: 'I' },
                { r: 5, c: 10, val: 'S' },
                { r: 14, c: 10, val: 'N' },
                { r: 2, c: 4, val: 'M' },
            ];

            // 1. Init Grid
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    gridEl.appendChild(cell);
                    cells.push({ el: cell, r, c, active: false, box: null, char: '' });
                }
            }

            // 2. Place Words
            words.forEach(wd => {
                for (let i = 0; i < wd.w.length; i++) {
                    let r = wd.r;
                    let c = wd.c;
                    if (wd.d === 'H') c += i;
                    else r += i;

                    // Find cell
                    const cellObj = cells.find(x => x.r === r && x.c === c);
                    if (cellObj) {
                        cellObj.char = wd.w[i];
                        cellObj.active = true;
                        // Create input if not exists
                        if (!cellObj.box) {
                            const input = document.createElement('input');
                            input.className = 'cell-input';
                            input.maxLength = 1;
                            // Handle prefill
                            const pref = prefilled.find(p => p.r === r && p.c === c);
                            if (pref) {
                                input.value = pref.val;
                                input.classList.add('prefilled');
                                input.readOnly = true;
                            }
                            // Focus logic
                            input.oninput = (e) => {
                                e.target.value = e.target.value.toUpperCase();
                                // Auto jump
                                // Simple version: find next active cell horizontal or vertical?
                                // Just simplified navigation
                            };
                            cellObj.el.appendChild(input);
                            cellObj.box = input;
                        }
                    }
                }
            });

            window.checkCrossword = function () {
                let allCorrect = true;
                cells.forEach(c => {
                    if (c.active && c.box) {
                        if (c.box.value.toUpperCase() !== c.char) {
                            allCorrect = false;
                            if (!c.box.classList.contains('prefilled')) c.box.style.color = 'red';
                        } else {
                            c.box.classList.add('correct');
                            c.box.style.color = 'white';
                        }
                    }
                });

                if (allCorrect) {
                    // HIGHLIGHT REVEAL: MINICONSTANT
                    const targetName = "MINICONSTANT";
                    const usedCells = new Set();

                    // Simple greedy finder for letters
                    for (let char of targetName) {
                        const cell = cells.find(c => c.active && c.char === char && !usedCells.has(c));
                        if (cell && cell.box) {
                            cell.box.classList.add('highlight-reveal');
                            usedCells.add(cell);
                        }
                    }

                    // WAIT LONGER (5s) TO OBSERVE
                    setTimeout(startScrabble, 5000);
                } else {
                    // Short buzz? (Optional)
                }
            };

            // --- SCRABBLE LOGIC ---
            function startScrabble() {
                document.getElementById('phase-cw').style.display = 'none';
                const sPhase = document.getElementById('phase-scrabble');
                sPhase.style.display = 'flex';

                const targetPhrase = "MINI CONSTANT";
                const targetClean = targetPhrase.replace(/\s/g, '');
                const letters = targetClean.split('').sort(() => Math.random() - 0.5);

                const container = document.getElementById('scrabble-container');
                const pool = document.getElementById('scrabble-letters');

                // Create slots
                for (let i = 0; i < targetPhrase.length; i++) {
                    const char = targetPhrase[i];
                    if (char === ' ') {
                        // Spacer
                        const spacer = document.createElement('div');
                        spacer.style.width = "10px";
                        container.appendChild(spacer);
                    } else {
                        const slot = document.createElement('div');
                        slot.className = 'tile-slot';
                        slot.dataset.expected = char;
                        slot.dataset.filled = "false";

                        // Click on slot to remove tile (if we want that feature, keep simple for now)
                        slot.onclick = () => {
                            if (slot.firstChild) {
                                const tile = slot.firstChild;
                                tile.classList.remove('placed');
                                pool.appendChild(tile);
                                slot.dataset.filled = "false";
                            }
                        };
                        container.appendChild(slot);
                    }
                }

                // Create tiles
                letters.forEach(l => {
                    const tile = document.createElement('div');
                    tile.className = 'scrabble-tile';
                    tile.innerText = l;
                    tile.onclick = () => placeTile(tile);
                    pool.appendChild(tile);
                });
            }

            function placeTile(tile) {
                if (tile.parentElement.id !== 'scrabble-letters') return; // Already placed

                const slots = document.querySelectorAll('.tile-slot');
                // Find first empty slot
                for (let slot of slots) {
                    if (slot.dataset.filled === "false") {
                        slot.appendChild(tile);
                        slot.dataset.filled = "true";
                        tile.classList.add('placed');
                        checkScrabbleWin();
                        return;
                    }
                }
            }

            function checkScrabbleWin() {
                const slots = document.querySelectorAll('.tile-slot');
                let word = "";
                let allFilled = true;
                slots.forEach(s => {
                    if (s.dataset.filled === "false") allFilled = false;
                    if (s.firstChild) word += s.firstChild.innerText;
                });

                if (allFilled) {
                    if (word === "MINICONSTANT") {
                        document.getElementById('scrabble-message').innerText = "BRAVO ! IDENTITÉ CONFIRMÉE !";
                        setTimeout(startVignette, 2000);
                    } else {
                        document.getElementById('scrabble-message').innerText = "Pas encore ça...";
                        document.getElementById('scrabble-message').style.color = "orange";
                    }
                }
            }

            function startVignette() {
                document.getElementById('phase-scrabble').style.display = 'none'; // Hide Scrabble
                const vPhase = document.getElementById('phase-vignette');
                vPhase.style.display = 'flex';
                setTimeout(() => {
                    vPhase.style.transition = 'opacity 2s';
                    vPhase.style.opacity = '0';
                    setTimeout(startGame, 2000);
                }, 4000);
            }

            // --- GAME LOGIC ---
            let power = 0;
            let decay = 2.0;
            const maxPower = 100;
            let gameActive = false;
            let interval;

            function startGame() {
                document.getElementById('phase-vignette').style.display = 'none';
                const gamePhase = document.getElementById('phase-game');
                gamePhase.style.display = 'flex';
                gameActive = true;

                interval = setInterval(() => {
                    if (!gameActive) return;
                    if (power > 0) power -= decay;
                    if (power < 0) power = 0;
                    updateBar();
                }, 100);
            }

            window.tapSword = function (e) {
                if (e) e.preventDefault();
                if (!gameActive) return;

                power += 10;
                if (power >= maxPower) winGame();

                const sword = document.getElementById('sword-obj');
                sword.classList.remove('shake');
                void sword.offsetWidth;
                sword.classList.add('shake');
                updateBar();
            }

            function updateBar() {
                document.getElementById('power-bar').style.width = power + '%';
            }

            function winGame() {
                gameActive = false;
                clearInterval(interval);
                power = 100;
                updateBar();

                // UNLOCK DAY 24
                localStorage.setItem('sword_obtained', 'true');

                alert("VICTOIRE ! TU AS DÉCROCHÉ L'ÉPÉE ! Retourne vite dechirer la case 24 !");

                // CLOSE MODAL & REFRESH 
                document.getElementById('popup').style.display = 'none';

                // Trigger refresh of main calendar to update visual state (broken bars)
                if (window.parent && window.parent.initializeCalendar) {
                    window.parent.initializeCalendar();
                } else if (window.initializeCalendar) {
                    window.initializeCalendar();
                } else {
                    location.reload();
                }
            }

        })();
    </script>

</body>

</html>