<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>22 Décembre - Potion d'Amour</title>
    <style>
        /* Scoped styles for Day 22 */
        #content-22 {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            /* Light Background */
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 15px;
            color: #2c3e50;
            overflow: hidden;
        }

        /* COMIC PHASE */
        .comic-phase {
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            justify-content: center;
        }

        .comic-phase.active {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        .comic-wrapper {
            position: relative;
            max-width: 95%;
            /* Wider on mobile */
            margin-bottom: 10px;
            border: 5px solid #2c3e50;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Stack image and text */
            background: white;
        }

        .comic-wrapper img {
            width: 100%;
            height: auto;
            max-height: 50vh;
            /* Reduce max height to fit text */
            object-fit: contain;
            display: block;
        }

        .comic-text-overlay {
            /* Now a normal block below image */
            position: relative;
            bottom: auto;
            left: auto;
            transform: none;
            width: 100%;
            background: #fff;
            padding: 15px;
            box-sizing: border-box;
            /* padding inside width */
            border-top: 2px solid #2c3e50;
            border-radius: 0;
            color: #2c3e50;
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            font-size: 1em;
            /* readable size */
            text-align: center;
            box-shadow: none;
        }

        /* GAME PHASE */
        .game-phase {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .game-phase.active {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        /* Tubes Container */
        .tubes-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .tube {
            width: 50px;
            height: 160px;
            border: 3px solid rgba(44, 62, 80, 0.5);
            border-top: none;
            border-radius: 0 0 20px 20px;
            position: relative;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: transform 0.3s;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
        }

        .tube:hover {
            border-color: #2c3e50;
        }

        .tube.selected {
            transform: translateY(-20px);
            border-color: #e67e22;
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.5);
        }

        .liquid {
            width: 100%;
            height: 40px;
            transition: height 0.3s ease;
        }

        /* Colors */
        .color-red {
            background: #e74c3c;
        }

        .color-blue {
            background: #3498db;
        }

        .color-green {
            background: #2ecc71;
        }

        .btn-action {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Satisfy', cursive;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-action:hover {
            transform: scale(1.05);
            background-color: #c0392b;
        }

        h2 {
            font-family: 'Satisfy', cursive;
            margin: 10px 0;
            font-size: 2em;
            color: #2c3e50;
        }

        p {
            font-size: 1em;
            max-width: 80%;
            line-height: 1.4;
            color: #34495e;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="content-22">

        <!-- INTRO COMIC -->
        <div id="phase-intro" class="comic-phase active">
            <h2>L'Usine à Amour ?</h2>
            <div class="comic-wrapper">
                <img id="intro-img" src="images/scientifique_intro_indus.png" alt="BD Intro">
                <div class="comic-text-overlay" id="intro-text">
                    Scientifique : "L'Amour est une formule chimique ! Nous pouvons l'industrialiser et le vendre !"<br>
                    Aidez-le à isoler la molécule rouge...
                </div>
            </div>
            <button class="btn-action" onclick="nextIntro()">Commencer la production</button>
        </div>

        <!-- GAME -->
        <div id="phase-game" class="game-phase">
            <h2>Extraction en cours...</h2>
            <p>Triez les liquides pour obtenir la <strong>Potion d'Amour (Rouge)</strong> pure.</p>

            <div class="tubes-container" id="tubes-box">
                <!-- Generated by JS -->
            </div>

            <button class="btn-action" onclick="resetGame()"
                style="margin-top:30px; font-size:0.9em; background:#95a5a6;">Réinitialiser</button>
        </div>

        <!-- OUTRO COMIC -->
        <div id="phase-outro" class="comic-phase">
            <h2>Résultat de l'expérience...</h2>
            <div class="comic-wrapper">
                <img id="outro-img" src="images/scientifique_greedy.png" alt="BD Outro">
                <div class="comic-text-overlay" id="outro-text">
                    Scientifique : "Ça y est ! Pur à 99% ! On va le mettre en bouteille et devenir riches !"
                </div>
            </div>
            <button class="btn-action" onclick="nextOutro()">Suivant</button>
        </div>

    </div>

    <script>
        (function () {
            // --- COMIC LOGIC ---
            // Intro is single step now
            window.nextIntro = function () {
                document.getElementById('phase-intro').classList.remove('active');
                document.getElementById('phase-game').classList.add('active');
                initGame(); // Start Game
            };

            // Outro Sequence
            let outroStep = 0;
            const outroImages = [
                'images/scientifique_greedy.png',
                'images/chirurgien_fail.png',
                'images/chirurgien_moral.png'
            ];
            const outroTexts = [
                "Scientifique : 'Ça y est ! Pur à 99% ! On va le mettre en bouteille et devenir riches !'",
                "Chirurgien (après test) : 'Ça ne marche pas... C'est inerte. L'amour artificiel n'a aucune saveur.'",
                "Chirurgien : 'L'amour ne se fabrique pas. Regardez ces enfants... ils rayonnent parce qu'ils ont été nourris d'amour vrai. C'est ça le secret.'"
            ];

            window.nextOutro = function () {
                outroStep++;
                if (outroStep < outroImages.length) {
                    // Update Image and Text
                    const img = document.getElementById('outro-img');
                    const txt = document.getElementById('outro-text');

                    // Fade out effect manually slightly visible or just snap
                    img.src = outroImages[outroStep];
                    txt.innerText = outroTexts[outroStep];

                    if (outroStep === outroImages.length - 1) {
                        document.querySelector('#phase-outro .btn-action').innerText = "Vrai Amour";
                    }

                } else {
                    alert("Leçon apprise : L'Amour vient du cœur, pas d'un tube. À demain !");
                    window.location.reload();
                }
            };


            // --- GAME LOGIC (Water Sort) ---
            const LEVEL = [
                ['red', 'green', 'blue', 'red'], // Tube 0
                ['green', 'blue', 'red', 'green'], // Tube 1
                ['blue', 'red', 'green', 'blue'], // Tube 2
                [], // Tube 3
                []  // Tube 4
            ];

            let tubesState = JSON.parse(JSON.stringify(LEVEL));
            let selectedTubeIndex = -1;

            window.initGame = function () {
                renderTubes();
            };

            window.resetGame = function () {
                tubesState = JSON.parse(JSON.stringify(LEVEL));
                selectedTubeIndex = -1;
                renderTubes();
            }

            function renderTubes() {
                const container = document.getElementById('tubes-box');
                container.innerHTML = '';

                tubesState.forEach((tube, index) => {
                    const tubeDiv = document.createElement('div');
                    tubeDiv.className = 'tube';
                    if (selectedTubeIndex === index) tubeDiv.classList.add('selected');

                    tubeDiv.onclick = () => handleTubeClick(index);

                    tube.forEach(color => {
                        const liquid = document.createElement('div');
                        liquid.className = `liquid color-${color}`;
                        tubeDiv.appendChild(liquid);
                    });

                    container.appendChild(tubeDiv);
                });
            }

            function handleTubeClick(index) {
                if (selectedTubeIndex === -1) {
                    if (tubesState[index].length > 0) {
                        selectedTubeIndex = index;
                        renderTubes();
                    }
                } else {
                    if (selectedTubeIndex === index) {
                        selectedTubeIndex = -1;
                        renderTubes();
                    } else {
                        pour(selectedTubeIndex, index);
                    }
                }
            }

            function pour(fromIdx, toIdx) {
                const source = tubesState[fromIdx];
                const target = tubesState[toIdx];

                if (source.length === 0) return;

                const colorToPour = source[source.length - 1];

                if (target.length < 4) {
                    if (target.length === 0 || target[target.length - 1] === colorToPour) {
                        let unitsMoved = 0;
                        while (source.length > 0 &&
                            source[source.length - 1] === colorToPour &&
                            target.length < 4) {
                            target.push(source.pop());
                            unitsMoved++;
                        }

                        try { new Audio('images/water_pour.mp3').play().catch(() => { }); } catch (e) { }

                        selectedTubeIndex = -1;
                        renderTubes();
                        checkVictory();
                        return;
                    }
                }

                selectedTubeIndex = -1;
                try { new Audio('images/wrong.mp3').play().catch(() => { }); } catch (e) { }
                renderTubes();
            }

            function checkVictory() {
                let allSorted = true;
                for (let tube of tubesState) {
                    if (tube.length === 0) continue;
                    if (tube.length < 4) { allSorted = false; break; }
                    const firstColor = tube[0];
                    if (!tube.every(c => c === firstColor)) { allSorted = false; break; }
                }

                if (allSorted) {
                    setTimeout(() => {
                        document.getElementById('phase-game').classList.remove('active');
                        document.getElementById('phase-outro').classList.add('active');
                        try { new Audio('images/money_sound.mp3').play().catch(() => { }); } catch (e) { }
                    }, 500);
                }
            }

        })();
    </script>