<style>
    .scratch-container {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 0 auto;
        user-select: none;
        -webkit-user-select: none;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .scratch-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }

    #scratch-canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
        cursor: crosshair;
    }

    #win-message {
        display: none;
        text-align: center;
        margin-top: 20px;
        color: #d4af37;
        font-family: 'Satisfy', cursive;
        font-size: 1.8em;
        animation: popIn 0.5s ease;
    }

    @keyframes popIn {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        80% {
            transform: scale(1.1);
            opacity: 1;
        }

        100% {
            transform: scale(1);
        }
    }
</style>
<h1> Jour 3 </h1>
<h2>Banco ! </h2>

<div class="scratch-container">
    <img src="images/una.jpg" alt="surprise poilue" class="scratch-image">
    <canvas id="scratch-canvas"></canvas>
</div>

<div id="win-message">
    ðŸŽ‰ Tu as gagnÃ© un magnifique berger allemand de NoÃ«l ! ðŸŽ„
</div>

<script>
    (function () {
        const canvas = document.getElementById('scratch-canvas');
        const container = document.querySelector('.scratch-container');
        const ctx = canvas.getContext('2d');
        const winMessage = document.getElementById('win-message');
        let isDrawing = false;
        let won = false;

        // Ajuster la taille du canvas Ã  celle du conteneur
        function resizeCanvas() {
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // Charger la texture or
            const img = new Image();
            img.src = 'images/gold_glitter.png';
            img.onload = function () {
                const pattern = ctx.createPattern(img, 'repeat');
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Ajouter un texte ou motif sur la couche Ã  gratter
                ctx.font = 'bold 24px Montserrat';
                ctx.fillStyle = '#333'; // Texte foncÃ© pour contraster avec l'or
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = "white";
                ctx.shadowBlur = 5;
                ctx.fillText('GRATTES ICI', canvas.width / 2, canvas.height / 2);
                ctx.shadowBlur = 0; // Reset shadow
            };
        }

        // Initialiser
        // Petit dÃ©lai pour s'assurer que le conteneur a ses dimensions (si dans une modale)
        setTimeout(resizeCanvas, 100);

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function scratch(e) {
            if (!isDrawing || won) return;
            e.preventDefault(); // EmpÃªcher le scroll sur mobile

            const pos = getMousePos(e);

            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2); // Rayon du "grattage"
            ctx.fill();
        }

        function checkWin() {
            if (won) return;

            // Calculer le pourcentage grattÃ©
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let scratchedPixels = 0;

            // On parcourt les pixels (R, G, B, A) -> on regarde A (alpha) Ã  l'index i+3
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] === 0) {
                    scratchedPixels++;
                }
            }

            const totalPixels = canvas.width * canvas.height;
            const percentage = (scratchedPixels / totalPixels) * 100;

            if (percentage > 50) {
                won = true;
                // Tout effacer pour bien voir l'image
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Afficher le message
                winMessage.style.display = 'block';
            }
        }

        // Ã‰vÃ©nements Souris
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            scratch(e);
        });

        canvas.addEventListener('mousemove', scratch);

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
            checkWin();
        });

        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });

        // Ã‰vÃ©nements Touch (Mobile)
        canvas.addEventListener('touchstart', (e) => {
            isDrawing = true;
            scratch(e);
        }, { passive: false });

        canvas.addEventListener('touchmove', scratch, { passive: false });

        canvas.addEventListener('touchend', () => {
            isDrawing = false;
            checkWin();
        });
    })();
</script>